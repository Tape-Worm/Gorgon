version: 2.0.{build}
pull_requests:
  do_not_increment_build_number: true
branches:
  only:
  - master
skip_non_tags: true
configuration: ReleaseAndDeploy
platform: Any CPU
shallow_clone: true
assembly_info:
  patch: true
  file: '**\AssemblyInfo.*'
  assembly_version: '{version}'
  assembly_file_version: '{version}'
  assembly_informational_version: '{version}'
environment:
  gkey: eDKrI8Wf1hH2rloYqjD2dTEALUqY89j3yyj5KV82MHko6K62_9eWE98bOj8hif2Q
install:
- ps: >-
    nuget install secure-file -ExcludeVersion

    secure-file\tools\secure-file -decrypt Gorgon.enc -secret $env:gkey -out GorgonFull.snk
before_build:
- ps: .\ProjectSigner.exe GorgonFull.snk -y
build:
  project: Gorgon/Gorgon.sln
  parallel: true
  verbosity: normal
after_build:
- ps: >-
    $artifactDir = "Artifacts"

    $artifactBin = "$artifactDir\\Bin\\"

    $artifactPlugIns = "$artifactDir\\PlugIns\\"

    $artifactTools = "$artifactDir\\Tools\\"

    $artifactEditor = "$artifactTools\\Gorgon.Editor"

    $artifactEditorPlugIns = "$artifactEditor\\PlugIns"


    if (Test-Path $artifactDir)

    {
        rmdir $artifactDir -force -recurse
    }


    mkdir $artifactDir

    mkdir $artifactBin

    mkdir $artifactPlugIns

    mkdir $artifactTools

    mkdir $artifactEditor

    mkdir $artifactEditorPlugIns


    $gorgonDllsXmls = (Get-ChildItem "Gorgon\\" -include *.dll, *.xml -Recurse | where { $_.FullName -notmatch "\\obj\\" -and $_.FullName -notmatch "\\debug\\"})

    $plugInDlls = (Get-ChildItem "PlugIns\\Bin\\" -include *.dll -Recurse | where { $_.FullName -notmatch "\\debug\\"})

    $toolFiles = (Get-ChildItem "Tools\\Gorgon.Editor\\Bin\\Release\*" -include *.dll, Gorgon.Editor.exe, Gorgon.Editor.exe.config, texconv.exe )

    $toolPlugIns = (Get-ChildItem "Tools\\Gorgon.Editor\\Bin\\Release\\PlugIns\*" -include *.dll)


    ForEach ($dll in $gorgonDllsXmls)

    {
        Copy-Item $dll.FullName $artifactBin
    }


    ForEach ($plugInDll in $plugInDlls)

    {
        Copy-Item $plugInDll.FullName $artifactPlugIns
    }


    ForEach ($toolFile in $toolFiles)

    {
        Copy-Item $toolFile.FullName $artifactEditor
    }


    Foreach ($toolPlugIn in $toolPlugIns)

    {
        Copy-Item $toolPlugIn.FullName $artifactEditorPlugIns
    }
test: off
artifacts:
- path: Artifacts\
  name: Gorgon2.0
deploy: off